<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>User's Guide for Braid and Strand Camera</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Low latency image processing and tracking">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="braid-and-strand-camera.html">Braid and Strand Camera</a></li><li class="chapter-item expanded "><a href="hardware-selection.html"><strong aria-hidden="true">1.</strong> Hardware selection</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="braidz-files.html"><strong aria-hidden="true">3.</strong> BRAIDZ files and Analysis Scripts</a></li><li class="chapter-item expanded "><a href="braid_3d_tracking.html"><strong aria-hidden="true">4.</strong> Braid: 3D Tracking</a></li><li class="chapter-item expanded "><a href="braid_calibration.html"><strong aria-hidden="true">5.</strong> Braid: 3D Calibration</a></li><li class="chapter-item expanded "><a href="braid_remote_cameras.html"><strong aria-hidden="true">6.</strong> Braid: Remote cameras</a></li><li class="chapter-item expanded "><a href="scripting-with-python.html"><strong aria-hidden="true">7.</strong> Scripting with Python</a></li><li class="chapter-item expanded "><a href="processing-saved-videos.html"><strong aria-hidden="true">8.</strong> Processing saved videos</a></li><li class="chapter-item expanded "><a href="troubleshooting.html"><strong aria-hidden="true">9.</strong> Troubleshooting</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">User's Guide for Braid and Strand Camera</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/strawlab/strand-braid" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#braid-and-strand-camera" id="braid-and-strand-camera">Braid and Strand Camera</a></h1>
<p>This is the User's Guide for <a href="https://strawlab.org/braid/">Braid</a> and <a href="https://strawlab.org/strand-cam/">Strand
Camera</a>.</p>
<p>Braid and Strand Camera are free and open source. You can find the source code
on <a href="https://github.com/strawlab/strand-braid">GitHub</a>. Issues and feature
requests can be posted on the <a href="https://github.com/strawlab/strand-braid/issues">GitHub issue
tracker</a>.</p>
<h3><a class="header" href="#about-this-book" id="about-this-book">About this book</a></h3>
<p>The source code for this documentation is at
<a href="https://github.com/strawlab/strand-braid/tree/main/strand-braid-user/users-guide">github.com/strawlab/strand-braid/tree/main/strand-braid-user/users-guide</a>.
This book is made with <a href="https://rust-lang.github.io/mdBook/">mdBook</a>.</p>
<h1><a class="header" href="#hardware-selection" id="hardware-selection">Hardware selection</a></h1>
<h2><a class="header" href="#pc-requirements" id="pc-requirements">PC requirements</a></h2>
<ul>
<li>Supports Ubuntu 20.04 amd64 operating system. This is currently our only
supported platform.</li>
<li>Fast CPU. Currently an Intel CPU is recommended due to the use of the Intel
Integrated Performance Primitives Library.</li>
<li>Memory usage is not expected to be particularly high, because processing
occurs in realtime.</li>
<li>Sufficient and fast interfaces to cameras. If your cameras are USB3 or Gigabit
ethernet, your computer needs to support enough bandwidth.</li>
<li>Disk space and speed. For realtime tracking, the tracking data is only modest
in size and so no particularly high performance requirements exist. For
streaming uncompressed raw video to disk (with the FMF format), very fast
disks and lots of disk space are required. As an alternative, compressed
videos can be saved to the MKV format. This requires either substantial CPU
usage (VP8 or VP9 encoding) or NVIDIA hardware (h264 encoding with NVENC, see below).</li>
</ul>
<h3><a class="header" href="#hardware-accelerated-video-encoding-using-nvidia-video-cards" id="hardware-accelerated-video-encoding-using-nvidia-video-cards">Hardware-accelerated video encoding using nvidia video cards</a></h3>
<p>NVIDIA video encoding hardware is optionally used to encode h264 videos in the
MKV format. This is very nice because it takes almost no CPU and full framerate
videos can be recorded from your cameras during live tracking with little or no
loss of performance. This depends on NVIDIA's library called NVENC. Please see
NVIDIA's site for <a href="https://developer.nvidia.com/video-encode-and-decode-gpu-support-matrix-new">supported
hardware</a>.
Note in particular the limit of three encode sessions with the consumer
(GeForce) hardware that does not exist on many of their professional (Quadro)
cards.</p>
<h2><a class="header" href="#camera-requirements" id="camera-requirements">Camera requirements</a></h2>
<p>Currently, Basler cameras using the Pylon API are the only supported cameras. We
plan to support cameras from Allied Vision using the Vimba API in late 2021 or 2022.</p>
<h3><a class="header" href="#basler-cameras" id="basler-cameras">Basler cameras</a></h3>
<p>Due to the use of the Pylon API, any camera which can be used in the Pylon
Viewer can be used in principle. In practice, we regularly test with the
following cameras:</p>
<ul>
<li>Basler a2A1920-160umPRO</li>
<li>Basler a2A1920-160umBAS</li>
<li>Basler acA1300-200um</li>
<li>Basler acA640-120gm</li>
</ul>
<h3><a class="header" href="#allied-vision-cameras-planned-for-late-2021-or-2022" id="allied-vision-cameras-planned-for-late-2021-or-2022">Allied Vision cameras (Planned for late 2021 or 2022)</a></h3>
<p>Due to the use of the Vimba API, any camera which can be used in the Vimba
Viewer can be used in principle. In practice, we intend to use the following
cameras:</p>
<ul>
<li>Allied Vision Alvium 1800 U-240m</li>
</ul>
<h1><a class="header" href="#installation" id="installation">Installation</a></h1>
<h2><a class="header" href="#software-installation" id="software-installation">Software installation</a></h2>
<h2><a class="header" href="#hardware-installation" id="hardware-installation">Hardware installation</a></h2>
<h3><a class="header" href="#cameras" id="cameras">Cameras</a></h3>
<p>Currently only Basler cameras are supported. We use Basler's Pylon library to
access the cameras.</p>
<p>Support for other cameras is planned.</p>
<h3><a class="header" href="#trigger-box" id="trigger-box">Trigger box</a></h3>
<p>Braid uses the <a href="https://github.com/strawlab/triggerbox">Straw Lab Triggerbox</a>
hardware to synchronize the cameras. This is based on an Arduino
microcontroller.</p>
<h3><a class="header" href="#trigger-cables" id="trigger-cables">Trigger cables</a></h3>
<p>TODO: write this and describe how to check everything is working.</p>
<h1><a class="header" href="#braidz-files" id="braidz-files"><code>.braidz</code> files</a></h1>
<p>A <code>.braidz</code> file contains the results of realtime tracking, the tracking
parameters, and so on.</p>
<h2><a class="header" href="#online-viewer" id="online-viewer">Online viewer</a></h2>
<p>An online viewer for <code>.braidz</code> files is at <a href="https://braidz.strawlab.org/">braidz.strawlab.org</a>.</p>
<h2><a class="header" href="#analysis-scripts" id="analysis-scripts">Analysis scripts</a></h2>
<p>The following plots were made with the file
<a href="http://strawlab-cdn.com/assets/20201112_133722.braidz">20201112_133722.braidz</a>.
The scripts can be accessed at
<a href="https://github.com/strawlab/strand-braid/tree/main/strand-braid-user/analysis">github.com/strawlab/strand-braid/tree/main/strand-braid-user/analysis</a>.</p>
<h3><a class="header" href="#braid-analysis-plot-data2d-timeseriespy" id="braid-analysis-plot-data2d-timeseriespy"><code>braid-analysis-plot-data2d-timeseries.py</code></a></h3>
<p><img src="braid-analysis-plot-data2d-timeseries.png" alt="braid-analysis-plot-data2d-timeseries.png" /></p>
<h3><a class="header" href="#braid-analysis-plot-kalman-estimates-timeseriespy" id="braid-analysis-plot-kalman-estimates-timeseriespy"><code>braid-analysis-plot-kalman-estimates-timeseries.py</code></a></h3>
<p><img src="braid-analysis-plot-kalman-estimates-timeseries.png" alt="braid-analysis-plot-kalman-estimates-timeseries.png" /></p>
<h3><a class="header" href="#braid-analysis-plot3dpy" id="braid-analysis-plot3dpy"><code>braid-analysis-plot3d.py</code></a></h3>
<p><img src="braid-analysis-plot3d.png" alt="braid-analysis-plot3d.png" /></p>
<h2><a class="header" href="#file-format" id="file-format">File Format</a></h2>
<p>A <code>.braidz</code> file is actually a ZIP file with specific contents. It can be
helpful to know about these specifics when problems arise.</p>
<h3><a class="header" href="#showing-the-contents-of-a-braidz-file" id="showing-the-contents-of-a-braidz-file">Showing the contents of a <code>.braidz</code> file</a></h3>
<p>You can show the filenames inside a .braidz file with
<code>unzip -l FILENAME.braidz</code>.</p>
<h3><a class="header" href="#extracting-a-braidz-file" id="extracting-a-braidz-file">Extracting a <code>.braidz</code> file</a></h3>
<p>You can extract a <code>.braidz</code> file to its contents with <code>unzip FILENAME.braidz</code>.</p>
<h3><a class="header" href="#creating-a-braidz-file" id="creating-a-braidz-file">Creating a <code>.braidz</code> file</a></h3>
<p>You can create a new <code>.braidz</code> file with:</p>
<pre><code>cd BRAID_DIR
zip ../FILENAME.braidz *
</code></pre>
<p>Note, your <code>.braidz</code> file should look like this - with no directories other than
<code>images/</code>.</p>
<pre><code>$ unzip -l 20191125_093257.braidz
Archive:  20191125_093257.braidz
zip-rs
  Length      Date    Time    Name
---------  ---------- -----   ----
       97  2019-11-25 09:33   README.md
      155  2019-11-25 09:33   braid_metadata.yml
        0  2019-11-25 09:33   images/
   308114  2019-11-25 09:33   images/Basler_22005677.png
   233516  2019-11-25 09:33   images/Basler_22139107.png
   283260  2019-11-25 09:33   images/Basler_22139109.png
   338040  2019-11-25 09:33   images/Basler_22139110.png
       78  2019-11-25 09:33   cam_info.csv.gz
     2469  2019-11-25 09:33   calibration.xml
      397  2019-11-25 09:33   textlog.csv.gz
   108136  2019-11-25 09:33   kalman_estimates.csv.gz
      192  2019-11-25 09:33   trigger_clock_info.csv.gz
       30  2019-11-25 09:33   experiment_info.csv.gz
     2966  2019-11-25 09:33   data_association.csv.gz
   138783  2019-11-25 09:33   data2d_distorted.csv.gz
---------                     -------
  1416233                     15 files
</code></pre>
<p>Note that the following is NOT a valid <code>.braidz</code> file because it has a leading
directory name for each entry.</p>
<pre><code>$ unzip -l 20191119_114103.NOT-A-VALID-BRAIDZ
Archive:  20191119_114103.NOT-A-VALID-BRAIDZ
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  2019-11-19 11:41   20191119_114103.braid/
       97  2019-11-19 11:41   20191119_114103.braid/README.md
      155  2019-11-19 11:41   20191119_114103.braid/braid_metadata.yml
        0  2019-11-19 11:41   20191119_114103.braid/images/
   320906  2019-11-19 11:41   20191119_114103.braid/images/Basler_22005677.png
   268847  2019-11-19 11:41   20191119_114103.braid/images/Basler_22139107.png
   308281  2019-11-19 11:41   20191119_114103.braid/images/Basler_22139109.png
   346232  2019-11-19 11:41   20191119_114103.braid/images/Basler_22139110.png
   225153  2019-11-19 11:41   20191119_114103.braid/images/Basler_40019416.png
       86  2019-11-19 11:41   20191119_114103.braid/cam_info.csv.gz
     2469  2019-11-19 11:41   20191119_114103.braid/calibration.xml
       10  2019-11-19 11:41   20191119_114103.braid/textlog.csv.gz
       10  2019-11-19 11:41   20191119_114103.braid/kalman_estimates.csv.gz
       10  2019-11-19 11:41   20191119_114103.braid/trigger_clock_info.csv.gz
       10  2019-11-19 11:41   20191119_114103.braid/experiment_info.csv.gz
       10  2019-11-19 11:41   20191119_114103.braid/data_association.csv.gz
 20961850  2019-11-19 12:17   20191119_114103.braid/data2d_distorted.csv.gz
---------                     -------
 22434126                     17 files
</code></pre>
<h1><a class="header" href="#3d-tracking-in-braid" id="3d-tracking-in-braid">3D Tracking in Braid</a></h1>
<h2><a class="header" href="#principle-of-operation" id="principle-of-operation">Principle of operation</a></h2>
<p>This page describes the basic principles of how tracking in 3D is implemented by
Braid. A more detailed and more mathematical description can be found in the
paper describing Braid's predecessor, Straw et al. (2011). Please refer to this
for more details.</p>
<p>Straw et al. 2011: Straw AD, Branson K, Neumann TR, Dickinson MH (2011) Multicamera
Realtime 3D Tracking of Multiple Flying Animals. <em>Journal of The Royal Society
Interface 8</em>(11), 395-409.
<a href="http://dx.doi.org/10.1098/rsif.2010.0230">doi:10.1098/rsif.2010.0230</a></p>
<p><img src="rsif20100230f02.jpg" alt="rsif20100230f02.jpg" />.</p>
<p><strong>Figure 1: Principles of 3D Tracking in Braid.</strong> References in blue refer to
parts of <a href="http://dx.doi.org/10.1098/rsif.2010.0230">Straw et al. (2011)</a>. (a)
Flowchart of operations. (b) Schematic of a two-dimensional camera view showing
the raw images (brown), feature extraction (blue), state estimation (black), and
data association (red). (c) Three-dimensional reconstruction using the EKF uses
prior state estimates (open circle) and observations (blue lines) to construct a
posterior state estimate (filled circle) and covariance ellipsoid (dotted
ellipse). This figure and some caption text reproduced from Figure 2 of <a href="http://dx.doi.org/10.1098/rsif.2010.0230">Straw
et al. (2011)</a> under the Creative
Commons Attribution License.</p>
<p>(TODO: walkthrough of figure above.)</p>
<h2><a class="header" href="#tracking-in-water-with-cameras-out-of-water" id="tracking-in-water-with-cameras-out-of-water">Tracking in water with cameras out of water</a></h2>
<p>One important aspect of Braid not covered in <a href="http://dx.doi.org/10.1098/rsif.2010.0230">Straw et al.
(2011)</a> is the the capability of
tracking fish (or other objects in water) from cameras placed above the water
surface.</p>
<h3><a class="header" href="#refraction" id="refraction">Refraction</a></h3>
<p>When looking through the air-water interface (or any refractive boundary),
objects on the other side appear from a different direction than the direct path
to the object due to <a href="https://en.wikipedia.org/wiki/Refraction">refraction</a>.
Mathematically, refraction is described by <a href="https://en.wikipedia.org/wiki/Fermat%27s_principle">Fermat's principle of least
time</a>, and this forms the
basis of Braid's tracking in water.</p>
<h3><a class="header" href="#principle-of-operation-for-tracking-in-water" id="principle-of-operation-for-tracking-in-water">Principle of operation for tracking in water</a></h3>
<p>When considering the principle of operation of 3D tracking described above, the
primary addition to Braid required for tracking in water is the ability to model
the rays coming from the animal to the camera not as straight lines but rather
having a bend due to refraction. To implement this, the observation model of the
extended Kalman filter is extended to incorporate the air-water boundary so that
it consists of both a 3D camera model and air-water surface model. Thus, during
the update step of the Kalman filter, this non-linear model is linearized about
the expected (<em>a priori</em>) position of the tracked object.</p>
<p>Currently, Braid has a simplification that the model of the air-water boundary
is always fixed at z=0. Thus, anything with z&lt;0 is under water and anything with
z&gt;0 is above water. This implies that the coordinate frame for tracking with an
air-water boundary must have this boundary at z=0 for correct tracking.</p>
<h3><a class="header" href="#how-to-enable-tracking-in-water" id="how-to-enable-tracking-in-water">How to enable tracking in water.</a></h3>
<p>Practically speaking, tracking using the model of an air-water boundary is
enabled by placing the string <code>&lt;water&gt;1.333&lt;/water&gt;</code> the XML camera calibration
file. This will automatically utilize the refractive boundary model described
above with a value for the refractive index of 1.333 for the medium at z&lt;0. As
1.333 is the refractive index of water, it is a model of refraction in water.</p>
<h1><a class="header" href="#calibration-in-braid" id="calibration-in-braid">Calibration in Braid</a></h1>
<h2><a class="header" href="#what-is-a-calibration" id="what-is-a-calibration">What is a calibration?</a></h2>
<p>In our usage here, we refer to a calibration as a model of a camera which allows
us to compute the 2D image location of a given 3D point. Braid can use
calibrations of multiple cameras to calculate the 3D position of a given point
when viewed in 2D camera images.</p>
<p>For a given camera, the calibration is divided into two parts. The &quot;extrinsics&quot;,
or extrinsic parameters, define the pose of the camera. This is the 3D position
and orientation of the camera. The &quot;intrinsics&quot;, or intrinsic parameters, define
the projection of 3D coordinates relative to the camera to an image point in
pixels. In Braid, the camera model is a pinhole model with warping distortion.
The intrinsic parameters include focal length, the pixel coordinates of the
optical axis, and the radial and tangential parameters of a &quot;plumb bob&quot;
distortion model.</p>
<h2><a class="header" href="#xml-calibration-files-in-braid" id="xml-calibration-files-in-braid">XML calibration files in Braid</a></h2>
<p>The XML calibration files used in Braid are backwards-compatible with those from
Braid's predecessor, Flydra. Several of the steps described here also use tools
from Flydra.</p>
<h2><a class="header" href="#step-1-setup-cameras-zoom-focus-aperture-gain-and-lights" id="step-1-setup-cameras-zoom-focus-aperture-gain-and-lights">Step 1: setup cameras (zoom, focus, aperture, gain) and lights</a></h2>
<p>Setup camera position, zoom, focus (using an object in the tracking volume) and
aperture (slightly stopped down from wide-open). Exposure times and gains are
set in Strand Cam for each camera individually. Note that if you intend to run
at 100 frames per second, exposure times must be less than 10 milliseconds.
These settings (exposure time and gain) are (unfortunately) currently not saved
in any file, and can be set only in the camera settings GUI (in the browser).
The camera keeps these values persistently when it is on, but if it has been
power cycled, it will reset to new values.</p>
<p>Try to a luminance distribution which extends across the entire dynamic range of
your sensor (from intensity values 0 to 255) with very little clipping.</p>
<h2><a class="header" href="#step-2-run-checkerboard-calibration-to-get-the-camera-intrinsic-parameters" id="step-2-run-checkerboard-calibration-to-get-the-camera-intrinsic-parameters">Step 2: run &quot;Checkerboard Calibration&quot; to get the camera intrinsic parameters</a></h2>
<p>(There is a script to draw checkerboards as SVG files:
<a href="https://github.com/strawlab/strand-braid/blob/main/strand-braid-user/scripts/draw_checkerboard_svg.py"><code>draw_checkerboard_svg.py</code></a>.)</p>
<p>In Strand Cam, there is a region called &quot;Checkerboard Calibration&quot; which allows
you to calibrate the camera intrinsic parameters. Show a checkerboard to the
camera. You must enter your the checkerboard parameters into the user interface.
For example, a standard 8x8 checkerboard would have 7x7 corners. Try to show the
checkerboard at different distances and angles. Do not forget to show the
checkerboard corners in the corners of the camera field of view. There is a
field which shows the number of checkerboard collected - this should increase as
the system detects checkerboards. When you have gathered a good set of (say, at
least 10) checkerboards, click the &quot;Perform and Save Calibration&quot; button. The
results of this calibration are saved to the directory
<code>$HOME/.config/strand-cam/camera_info</code>.</p>
<p>Repeat this for all cameras before proceeding to the next step.</p>
<h2><a class="header" href="#step-3-collect-calibration-data-and-run-multicamselfcal-mcsc" id="step-3-collect-calibration-data-and-run-multicamselfcal-mcsc">Step 3: collect calibration data and run MultiCamSelfCal (MCSC)</a></h2>
<p>To calibrate Braid, we use
<a href="https://github.com/strawlab/MultiCamSelfCal">MultiCamSelfCal</a>. This is a
software package which takes simultaneously captured images of an LED moving
through a volume to create a single calibration for all cameras.</p>
<h3><a class="header" href="#acquire-a-dataset-for-multicamselfcal" id="acquire-a-dataset-for-multicamselfcal">Acquire a dataset for MultiCamSelfCal</a></h3>
<p>Room lights should be off.</p>
<p>Synchronize your cameras and start saving data and begin to collect data by
moving a LED in the arena (try move the LED in the whole arena volume, also turn
it off and on sometimes to validate synchronization). When you are done, stop
saving.</p>
<h3><a class="header" href="#convert-braidz-file-to-flydra-mainbrain-h5-file" id="convert-braidz-file-to-flydra-mainbrain-h5-file">Convert <code>.braidz</code> file to flydra mainbrain <code>.h5</code> file</a></h3>
<blockquote>
<p>Note: from here in the document, there are many commands used from
<a href="https://github.com/strawlab/flydra">Flydra</a>. While Braid itself runs without
needing Flydra in any way, performing calibration and other data analysis
steps currently requires the use of Flydra. Specifically, the
<code>flydra_analysis</code> package is required. Please see
<a href="https://github.com/strawlab/flydra#installation">here</a> for instructions about
Flydra installation.</p>
</blockquote>
<p>By converting from <code>.braidz</code> to a Flydra mainbrain <code>.h5</code> file, you can use the
wide range of analysis programs from <a href="https://github.com/strawlab/flydra">flydra</a>.</p>
<p>For example, let's say you have the file <code>20190924_161153.braidz</code> saved by the
Braid program. We will use the script <code>convert_kalmanized_csv_to_flydra_h5.py</code>
to do this conversion:</p>
<pre><code>python ~/src/strand-braid/strand-braid-user/scripts/convert_kalmanized_csv_to_flydra_h5.py 20190924_161153.braidz
</code></pre>
<p>Upon success, there will be a new file saved with the suffix <code>.h5</code>. In this
case, it will be named <code>20190924_161153.braidz.h5</code>.</p>
<p>We can do the above but making use of bash variables to save typing later <code>BRAIDZ_FILE</code>.</p>
<pre><code>BRAIDZ_FILE=20190924_161153.braidz
DATAFILE=&quot;$BRAIDZ_FILE.h5&quot;
python ~/src/strand-braid/strand-braid-user/scripts/convert_kalmanized_csv_to_flydra_h5.py $BRAIDZ_FILE
</code></pre>
<p>Note that this conversion requires the program <code>compute-flydra1-compat</code> (from
the <code>braid-offline</code> package) to be on your path if you are converting 3D
trajectories.</p>
<h3><a class="header" href="#run-multicamselfcal-on-data-collected-with-braid" id="run-multicamselfcal-on-data-collected-with-braid">Run MultiCamSelfCal on data collected with Braid</a></h3>
<p>You can collect data and calibrate similar to <a href="https://github.com/strawlab/flydra/blob/c9f20d5f8f4feb7e1fe008cf0ee67fbbc70b1ba0/docs/flydra-sphinx-docs/calibrating.md">the description for Flydra</a></p>
<p>If your mainbrain <code>.h5</code> file is in the location <code>$DATAFILE</code>, you can run the <a href="https://github.com/strawlab/MultiCamSelfCal">MultiCamSelfCal</a>
program on this data to generate a multiple camera calibration.</p>
<pre><code>flydra_analysis_generate_recalibration --2d-data $DATAFILE --disable-kalman-objs $DATAFILE --undistort-intrinsics-yaml=$HOME/.config/strand-cam/camera_info  --run-mcsc --use-nth-observation=4
</code></pre>
<p>This will print various pieces of imformation to the console when it runs. First it will print something like this:</p>
<pre><code>851 points
by camera id:
 Basler_40022057: 802
 Basler_40025037: 816
 Basler_40025042: 657
 Basler_40025383: 846
by n points:
 3: 283
 4: 568
</code></pre>
<p>This means that 851 frames were acquired in which 3 or more cameras detected exactly one point.
The contribution from each camera is listed. In this example, all cameras had between 657 and
846 points. Then, the number of points detected by exactly 3 cameras is shown (283 such frames)
and exactly 4 cameras (568 frames).</p>
<p>Important things to watch for are listed here. These may be useful, but are rather
rough guidelines to provide some orientation:</p>
<ul>
<li>
<p>No camera should have very few points, otherwise this camera will not contribute much to
the overall calibration and will likely have a bad calibration itself.</p>
</li>
<li>
<p>The number of points used should be somewhere between 300 and 1000. Fewer than 300 points
often results in poor quality calibrations. More than 1000 points results in the calibration
procedure being very slow. The <code>--use-nth-observation</code> command line argument can be used
to change the number of points used.</p>
</li>
</ul>
<p>After running successfully, the console output should look something like this:</p>
<pre><code>********** After 0 iteration *******************************************
RANSAC validation step running with tolerance threshold: 10.00 ...
RANSAC: 1 samples, 811 inliers out of 811 points
RANSAC: 2 samples, 811 inliers out of 811 points
RANSAC: 2 samples, 762 inliers out of 762 points
RANSAC: 1 samples, 617 inliers out of 617 points
811 points/frames have survived validations so far
Filling of missing points is running ...
Repr. error in proj. space (no fact./fact.) is ...  0.386139 0.379033
************************************************************
Number of detected outliers:   0
About cameras (Id, 2D reprojection error, #inliers):
CamId    std       mean  #inliers
  1      0.41      0.41    762
  2      0.33      0.33    811
  3      0.49      0.41    617
  4      0.33      0.37    811
***************************************************************
**************************************************************
Refinement by using Bundle Adjustment
Repr. error in proj. space (no fact./fact./BA) is ...  0.388949 0.381359 0.358052
2D reprojection error
All points: mean  0.36 pixels, std is 0.31

finished: result in  /home/strawlab/20190924_161153.braidz.h5.recal/result
</code></pre>
<p>Important things to watch for:</p>
<ul>
<li>
<p>There should only be one iteration (numbered <code>0</code>).</p>
</li>
<li>
<p>The mean reprojection error should be low. Certainly less than
1 pixel and ideally less than 0.5 pixels as shown here.</p>
</li>
<li>
<p>The reprojection error should be low across all cameras.</p>
</li>
</ul>
<p>The above example calibration is a good one.</p>
<h3><a class="header" href="#convert-your-new-calibration-to-an-xml-file-which-can-be-used-by-braid" id="convert-your-new-calibration-to-an-xml-file-which-can-be-used-by-braid">Convert your new calibration to an XML file which can be used by Braid</a></h3>
<p>Convert this to XML:</p>
<pre><code>flydra_analysis_calibration_to_xml ${DATAFILE}.recal/result &gt; new-calibration-name.xml
</code></pre>
<p>You may now use this new calibration, saved as an XML file, as the calibration
for Braid. Specify the filename of your new XML file as <code>cal_fname</code> in the
<code>[mainbrain]</code> section of your Braid configuration <code>.toml</code> file.</p>
<h3><a class="header" href="#with-the-new-calibration-perform-offline-tracking-the-data-used-to-calibrate" id="with-the-new-calibration-perform-offline-tracking-the-data-used-to-calibrate">With the new calibration, perform offline tracking the data used to calibrate.</a></h3>
<p>Now you have a working calibration, which is NOT aligned or scaled to any
coordinate system, but an (undefined) coordinate system that from MCSC code
picked. We can use this calibration to do tracking, although in general having
correct scaling is important for good tracking. The reason correct scaling is
important for good quality tracking is because Braid tracks using a dynamic
model of movement in which maneuverability is parameterized and tracking
performance is best when the actual maneuverability statistics match the
expected statistic.</p>
<p>So, using the calibration from above, perform 3D tracking of the data with:</p>
<pre><code>flydra_kalmanize ${DATAFILE} -r ${DATAFILE}.recal/result
</code></pre>
<p>You can view these results with:</p>
<pre><code>DATAFILE_RETRACKED=`python -c &quot;print('${DATAFILE}'[:-3])&quot;`.kalmanized.h5
flydra_analysis_plot_timeseries_2d_3d ${DATAFILE} -k ${DATAFILE_RETRACKED} --disable-kalman-smoothing
</code></pre>
<h3><a class="header" href="#align-your-new-calibration-using-a-gui" id="align-your-new-calibration-using-a-gui">Align your new calibration using a GUI</a></h3>
<p>Now we will take our existing &quot;unaligned&quot; calibration, and despite the scaling
and alignment issue, track some points so that we have 3D coordinates. We will
use these 3D coordinates to &quot;align&quot; our calibration -- to adjust its scaling,
rotation, and translation to arrive at a final calibration which outputs
coordinates in the desired frame.</p>
<p>Now, using the unaligned calibration from above, collect a dataset which
outlines the geometry of your arena or other key 3D points which we serve as
reference 3D points used to discover the correct alignment. We will use these
unaligned 3D points output from the unaligned calibration to determine an
alignment and scaling used to transform these 3D points to the correct,
&quot;aligned&quot; 3D points. These alignment parameters will be used to update the original unaligned calibration into the final aligned calibration.</p>
<p>The easiest way to acquire unaligned 3D points is to acquire a new dataset
directly by running Braid with the new unaligned calibration. Alternatively, one
can use a pre-existing 2D dataset and re-track it with <code>flydra_kalmanize</code> as
above. We will call this dataset for alignment <code>${NEW_TRACKED_DATA}</code>.</p>
<p>With this new dataset for alignment, we render the 3D tracks with a 3D model of
some pre-specified geometry in the correct coordinate frame. We then adjust the
alignment parameters by hand in a GUI. Here we align our newly tracked data in
file <code>${NEW_TRACKED_DATA}</code> against the <code>sample_bowl.xml</code> file from
<a href="https://github.com/strawlab/flydra/blob/main/flydra_analysis/flydra_analysis/a2/sample_bowl.xml">here</a>.
In this example, the <code>sample_bowl.xml</code> file outlines a circle with diameter 0.33
meters on the Z=0 plane. In this example, we tracked an LED outlining a circle
of diameter 0.33 meters and on the plane which will be Z=0 in our final
coordinate frame. Here is how to run the GUI program for running the alignment:</p>
<pre><code>flydra_analysis_calibration_align_gui --stim-xml ~/src/flydra/flydra_analysis/flydra_analysis/a2/sample_bowl.xml ${NEW_TRACKED_DATA}
</code></pre>
<h3><a class="header" href="#automatic-alignment-of-calibrations" id="automatic-alignment-of-calibrations">Automatic alignment of calibrations</a></h3>
<p>As an alternative to using the GUI to perform alignment, it is possible to find
the correct alignment automatically. The flydra program
<code>flydra_analysis_align_calibration</code> does this. The major mathematical operations
are performed in the <code>estsimt</code> function in
<a href="https://github.com/strawlab/flydra/blob/main/flydra_core/flydra_core/align.py"><code>flydra_core.align</code></a>.</p>
<p>(TODO: Write an example doing this.)</p>
<h3><a class="header" href="#calibration-with-water" id="calibration-with-water">Calibration with water</a></h3>
<p>As described
<a href="braid_3d_tracking.html#tracking-in-water-with-cameras-out-of-water">here</a>, Braid
can track objects in water. To enable this, place the string
<code>&lt;water&gt;1.333&lt;/water&gt;</code> in the XML camera calibration file.</p>
<h1><a class="header" href="#remote-cameras-for-braid" id="remote-cameras-for-braid">Remote Cameras for Braid</a></h1>
<h2><a class="header" href="#what-are-remote-cameras" id="what-are-remote-cameras">What are &quot;remote cameras&quot;?</a></h2>
<p>A remote camera, in the context of Braid, can be used to connect cameras on
separate computers over the network to an instance of Braid. One or more
instances of Strand Camera can thus run on computers other than the computer on
which Braid is running.</p>
<h2><a class="header" href="#starting-a-remote-camera" id="starting-a-remote-camera">Starting a remote camera</a></h2>
<p>If a particular camera is marked by setting <code>remote_camera = true</code> in the
<code>[[cameras]]</code> section of the Braid configuration TOML file, <code>braid run</code> does not
attempt to start the camera but rather waits for a network connection from a
Braid-tuned variant of Strand Camera. Only once all cameras listed in the TOML
file have connected will Braid synchronize the cameras and allow recording of
data.</p>
<p>To start Strand Camera as a remote camera for Braid, run
<code>braid-strand-cam-pylon</code> (to start a Braid-specific version of Strand Camera)
with the command line argument specifying the URL for the braid HTTP address.
The camera should also be specified on the command line, along with any other
options.</p>
<p>In the following example, the Strand Camera will open the camera named
<code>Basler-12345</code> and will connect to Braid running at <code>http://127.0.0.1:44444</code>.
Strand Camera will itself open the user interface at <code>http://127.0.0.1:12345/</code>.</p>
<pre><code>braid-strand-cam-pylon --camera-name Basler-12345 --http-server-addr 127.0.0.1:12345 http://127.0.0.1:44444
</code></pre>
<h1><a class="header" href="#scripting-with-python" id="scripting-with-python">Scripting with Python</a></h1>
<p>Everything in Strand Cam and Braid that can be controlled from the web browser
can also be controlled from a Python script. The general technique is to use a
Python library to connect to a running Strand Cam (or Braid) program exactly
like a web browser does it.</p>
<h2><a class="header" href="#demo-changing-tracking-settings-from-a-python-script" id="demo-changing-tracking-settings-from-a-python-script">Demo: changing tracking settings from a Python script</a></h2>
<p>TODO: describe how to use and modify the <a href="https://github.com/strawlab/strand-braid/blob/main/strand-braid-user/scripts/record-mkv-video.py"><code>record-mkv-video.py</code>
demo</a>.</p>
<h2><a class="header" href="#advanced-automating-manual-actions" id="advanced-automating-manual-actions">Advanced: automating manual actions</a></h2>
<p>TODO: describe how to use the developer tools to watch the network requests from
your browser to view HTTP POST callbacks taken on certain actions.</p>
<h2><a class="header" href="#advanced-running-strand-cam-within-python" id="advanced-running-strand-cam-within-python">Advanced: Running Strand Cam within Python</a></h2>
<p>It is also possible to run strand cam within a Python program. This allows, for
example, to analyze images from within a Python script with minimal latency. See
the
<a href="https://github.com/strawlab/strand-braid/tree/main/py-strandcam">py-strandcam</a>
directory.</p>
<h1><a class="header" href="#processing-recorded-videos-using-braid" id="processing-recorded-videos-using-braid">Processing recorded videos using Braid</a></h1>
<h2><a class="header" href="#overview" id="overview">Overview</a></h2>
<p>The <code>braid-process-video</code> program will takes video files and process them to
produce various outputs.</p>
<p><img src="braid-process-video.png" alt="braid-process-video.png" /></p>
<p>As shown in the figure, this program takes <code>.mkv</code> (or <code>.fmf</code>) video input files
saved by Braid and a configuration file and then creates an output <code>.mkv</code> video
which stitches the input videos together. Optionally, it can also plot 2D
detections from a <code>.braidz</code> file on top of the raw video.</p>
<h2><a class="header" href="#note" id="note">Note</a></h2>
<ul>
<li>The input videos must be saved by Braid to ensure that the timestamps for each
frame in the file are correctly stored.</li>
</ul>
<h2><a class="header" href="#example-usage" id="example-usage">Example usage</a></h2>
<p>Here is an example configuration file <code>braid-bundle-videos.toml</code>:</p>
<pre><code># The .braidz file with 2D detection data (optional).
input_braidz = &quot;20211011_163203.braidz&quot;

# This stanza specified that an output video will be made.
[[output]]
type = 'video'
filename = 'composite.mkv'

# The following sections specify video sources to use as input.
[[input_video]]
filename = 'movie20211011_163224.mkv'

[[input_video]]
filename = 'movie20211011_163228.mkv'
</code></pre>
<p>With such a configuration file, run the program like so:</p>
<pre><code>braid-process-video --config braid-bundle-videos.toml
</code></pre>
<h2><a class="header" href="#todo" id="todo">TODO</a></h2>
<p>There are many more options which can be configured in the <code>.toml</code> configuration
file and they should be documented.</p>
<h1><a class="header" href="#troubleshooting" id="troubleshooting">Troubleshooting</a></h1>
<h2><a class="header" href="#synchronization-problems" id="synchronization-problems">synchronization problems</a></h2>
<h2><a class="header" href="#any-other-problem-or-question" id="any-other-problem-or-question">any other problem or question</a></h2>
<p>Please <a href="https://github.com/strawlab/strand-braid/issues">report any issues you
face</a> or <a href="https://groups.google.com/forum/#!forum/multicams">ask any questions you
may have</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
